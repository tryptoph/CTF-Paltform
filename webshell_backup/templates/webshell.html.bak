{% extends "base.html" %}

{% block stylesheets %}
<link rel="stylesheet" href="{{ url_for('plugins.webshell.assets', path='css/webshell.css') }}">
{% endblock %}

{% block content %}
<div class="jumbotron">
  <div class="container">
    <h1>Web Desktop</h1>
    <p>Access interactive desktop environments</p>
  </div>
</div>

<div class="container">
  <div class="row">
    <div class="col-md-12">
      <div id="webshell-error" class="alert alert-danger" style="display: none;">
        <span id="webshell-error-msg"></span>
      </div>
      
      <div id="webshell-info" class="alert alert-info" style="display: none;">
        <span id="webshell-info-msg"></span>
      </div>
      
      {% if current_user is none %}
      <div class="alert alert-warning">
        <strong>Authentication Required</strong> - You need to be logged in to use Web Desktop.
        <a href="{{ url_for('auth.login') }}?next={{ request.path }}" class="btn btn-primary btn-sm ml-2">Login</a>
      </div>
      {% endif %}
    </div>
  </div>
  
  <div class="row" id="webshell-launcher" style="display: none;" {% if current_user is none %}data-disabled="true"{% endif %}>
    <div class="col-md-12">
      <div class="card">
        <div class="card-header">
          <h3>Start a Desktop Environment</h3>
        </div>
        <div class="card-body">
          <p>Choose an environment to launch:</p>
          
          <div class="row">
            {% for image in images %}
            <div class="col-md-4 mb-4">
              <div class="card h-100">
                <div class="card-body">
                  <h5 class="card-title">{{ image.name }}</h5>
                  <p class="card-text">{{ image.description }}</p>
                  <ul class="list-unstyled">
                    <li><strong>Resources:</strong> {{ image.memory_limit }} RAM, {{ image.cpu_limit }} CPU</li>
                    <li><strong>Timeout:</strong> {{ image.timeout // 60 }} minutes</li>
                    {% if image.has_desktop %}
                    <li><span class="badge badge-success">Desktop Available</span></li>
                    {% endif %}
                  </ul>
                </div>
                <div class="card-footer">
                  <button class="btn btn-primary btn-block launch-btn" data-image-id="{{ image.id }}">
                    Launch
                  </button>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="row" id="webshell-container" style="display: none;">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h3 id="desktop-title">Web Desktop</h3>
          <div>
            <span class="badge badge-info" id="webshell-time-remaining">00:00:00</span>
            <div class="btn-group ml-2">
              <button class="btn btn-sm btn-warning" id="renew-btn">Renew</button>
              <button class="btn btn-sm btn-danger" id="destroy-btn">Destroy</button>
            </div>
          </div>
        </div>
        <div class="card-body">
          <ul class="nav nav-tabs" id="webshell-tabs" role="tablist">
            <li class="nav-item">
              <a class="nav-link active" id="desktop-tab" data-toggle="tab" href="#desktop-content" role="tab">
                Desktop
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" id="info-tab" data-toggle="tab" href="#info-content" role="tab">
                Info
              </a>
            </li>
          </ul>
          
          <div class="tab-content pt-3" id="webshell-tab-content">
              <div id="desktop-content" class="tab-pane fade show active" role="tabpanel">
                <!-- Container access will be inserted here by JavaScript -->
                <div id="desktop-access-section" class="text-center py-5">
                  <p>Loading desktop access information...</p>
                </div>
              </div>
            
            <div class="tab-pane fade" id="info-content" role="tabpanel">
              <div class="row">
                <div class="col-md-6">
                  <div class="card">
                    <div class="card-header">
                      <h5>Connection Information</h5>
                    </div>
                    <div class="card-body">
                      <dl class="row">
                        <dt class="col-sm-4">Desktop URL</dt>
                        <dd class="col-sm-8"><code id="info-desktop-url">-</code></dd>
                        
                        <dt class="col-sm-4">Desktop Port</dt>
                        <dd class="col-sm-8"><code id="info-desktop-port">-</code></dd>
                        
                        <dt class="col-sm-4">Password</dt>
                        <dd class="col-sm-8"><code id="info-password">-</code></dd>
                      </dl>
                    </div>
                  </div>
                </div>
                
                <div class="col-md-6">
                  <div class="card">
                    <div class="card-header">
                      <h5>Session Information</h5>
                    </div>
                    <div class="card-body">
                      <dl class="row">
                        <dt class="col-sm-4">Started</dt>
                        <dd class="col-sm-8" id="info-start-time">-</dd>
                        
                        <dt class="col-sm-4">Time Remaining</dt>
                        <dd class="col-sm-8" id="info-time-remaining">-</dd>
                        
                        <dt class="col-sm-4">Renewals Used</dt>
                        <dd class="col-sm-8">
                          <span id="info-renewals">-</span> / <span id="info-max-renewals">-</span>
                        </dd>
                        
                        <dt class="col-sm-4">Image</dt>
                        <dd class="col-sm-8" id="info-image">-</dd>
                      </dl>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Add CSRF token meta tag for better compatibility -->
<meta name="csrf-token" content="{{ nonce }}">
<script src="{{ url_for('plugins.webshell.assets', path='js/webshell_new.js') }}"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    console.log('WebShell page loaded');
    console.log('CSRF Token:', '{{ nonce }}');
    console.log('Authentication status:', {% if current_user is not none %}true{% else %}false{% endif %});

    WebShell.init({
      apiEndpoint: '/api/v1/plugins/webshell/container',
      csrfToken: '{{ nonce }}',
      isAuthed: {% if current_user is not none %}true{% else %}false{% endif %},
      loginUrl: '{{ url_for("auth.login") }}?next={{ request.path }}'
    });
  });
</script>
{% endblock %}
