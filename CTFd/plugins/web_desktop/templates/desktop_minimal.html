{% extends "base.html" %}

{% block stylesheets %}
<style>
.desktop-card {
    margin-bottom: 20px;
    border: 1px solid rgba(0,0,0,.125);
    border-radius: .25rem;
    box-shadow: 0 4px 6px rgba(0,0,0,.1);
    background-color: #fff;
}
.desktop-card-header {
    padding: 1rem 1.25rem;
    background-color: #f8f9fa;
    border-bottom: 1px solid rgba(0,0,0,.125);
    font-weight: bold;
}
.desktop-card-body {
    padding: 1.5rem;
}
.template-card {
    border: 1px solid #ddd;
    border-radius: 5px;
    margin-bottom: 20px;
    transition: transform 0.3s;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
.template-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}
.template-card .card-header {
    background-color: #343a40;
    color: white;
    padding: 12px 15px;
    font-weight: bold;
}
.template-card .card-body {
    padding: 15px;
}
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h2>Kali Desktop</h2>

    {% if user %}
        {% if container %}
            <div class="desktop-card">
                <div class="desktop-card-header">
                    <div class="d-flex align-items-center">
                        <div>
                            <h3 class="mb-0">Active Desktop</h3>
                            <span class="badge badge-success">Running</span>
                        </div>
                    </div>
                </div>
                <div class="desktop-card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header bg-info text-white">
                                    <h5 class="mb-0"><i class="fas fa-info-circle"></i> Connection Information</h5>
                                </div>
                                <div class="card-body">
                                    <table class="table table-striped">
                                        <tr>
                                            <th>URL:</th>
                                            <td><a href="http://localhost:{{ container.port }}" target="_blank">http://localhost:{{ container.port }}</a></td>
                                        </tr>
                                        <tr>
                                            <th>Username:</th>
                                            <td><code>{{ username }}</code></td>
                                        </tr>
                                        <tr>
                                            <th>Password:</th>
                                            <td><code>{{ password }}</code></td>
                                        </tr>
                                    </table>
                                    <div class="text-center mt-3">
                                        <a href="http://localhost:{{ container.port }}" target="_blank" class="btn btn-lg btn-success">
                                            <i class="fas fa-external-link-alt"></i> Access Desktop
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0"><i class="fas fa-clock"></i> Session Information</h5>
                                </div>
                                <div class="card-body">
                                    <p><strong>Started:</strong> {{ container.start_time.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                                    <p><strong>Renewals:</strong> {{ container.renew_count }} / {{ max_renews }}</p>
                                    <div id="action-buttons" class="mt-3">
                                        {% if container.renew_count < max_renews %}
                                        <button class="btn btn-info mr-2" onclick="renewContainer()">
                                            <i class="fas fa-sync-alt"></i> Renew Session
                                        </button>
                                        {% endif %}
                                        <button class="btn btn-danger" onclick="if(confirm('Are you sure you want to terminate this desktop session?')) { deleteContainer(); }">
                                            <i class="fas fa-trash-alt"></i> Delete Session
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% else %}
            <div class="card">
                <div class="card-header">
                    <h3>Available Templates</h3>
                </div>
                <div class="card-body">
                    {% if templates %}
                        <div class="row">
                            {% for template in templates %}
                                <div class="col-md-4 mb-4">
                                    <div class="template-card">
                                        <div class="card-header">
                                            {{ template.name }}
                                        </div>
                                        <div class="card-body">
                                            <p>{{ template.description }}</p>
                                            <p><strong>Resources:</strong></p>
                                            <ul class="list-unstyled small">
                                                <li><i class="fas fa-memory"></i> RAM: {{ template.memory_limit }}</li>
                                                <li><i class="fas fa-microchip"></i> CPU: {{ template.cpu_limit }} cores</li>
                                                <li><i class="fas fa-network-wired"></i> Port: {{ template.desktop_port }}</li>
                                            </ul>
                                            <hr>
                                            <button class="btn btn-success btn-block launch-btn" data-template-id="{{ template.id }}">
                                                <i class="fas fa-rocket"></i> Launch Desktop
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <p>No desktop templates are available.</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="alert alert-info mt-3">
                <i class="fas fa-info-circle"></i>
                Desktop sessions will be available for {{ get_config("whale:docker_timeout", 3600)|int // 60 }} minutes after launch.
            </div>
        {% endif %}
    {% else %}
        <div class="alert alert-warning">
            <p>Please <a href="/login">login</a> to access desktop environments.</p>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<style>
/* Loading animation for Desktop Launch */
.circle-loader {
    margin: 0 auto;
    border: 3px solid rgba(0, 0, 0, 0.2);
    border-left-color: #5cb85c;
    animation: loader-spin 1.2s infinite linear;
    position: relative;
    display: inline-block;
    vertical-align: top;
    border-radius: 50%;
    width: 7em;
    height: 7em;
}

.load-complete {
    -webkit-animation: none;
    animation: none;
    border-color: #5cb85c;
    transition: border 500ms ease-out;
}

.checkmark {
    display: none;
}

.checkmark.draw:after {
    animation-duration: 800ms;
    animation-timing-function: ease;
    animation-name: checkmark;
    transform: scaleX(-1) rotate(135deg);
}

.checkmark:after {
    opacity: 1;
    height: 3.5em;
    width: 1.75em;
    transform-origin: left top;
    border-right: 3px solid #5cb85c;
    border-top: 3px solid #5cb85c;
    content: '';
    left: 2.25em;
    top: 3.75em;
    position: absolute;
}

@keyframes loader-spin {
    0% {
        transform: rotate(0deg);
    }
    100% {
        transform: rotate(360deg);
    }
}

@keyframes checkmark {
    0% {
        height: 0;
        width: 0;
        opacity: 1;
    }
    20% {
        height: 0;
        width: 1.75em;
        opacity: 1;
    }
    40% {
        height: 3.5em;
        width: 1.75em;
        opacity: 1;
    }
    100% {
        height: 3.5em;
        width: 1.75em;
        opacity: 1;
    }
}
</style>
<script>
function showAlert(message, type = 'danger') {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    `;

    // Insert at the top of the container
    const container = document.querySelector('.container');
    container.insertAdjacentHTML('afterbegin', alertHtml);

    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        const alertElement = document.querySelector('.alert');
        if (alertElement) {
            $(alertElement).alert('close');
        }
    }, 5000);
}

function deleteContainer() {
    // Show loading indicator
    showAlert('<i class="fas fa-spinner fa-spin"></i> Deleting desktop session...', 'info');

    fetch('/api/v1/plugins/ctfd-whale/container', {
        method: 'DELETE',
        credentials: 'same-origin',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('<i class="fas fa-check-circle"></i> Desktop session deleted successfully', 'success');
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showAlert('<i class="fas fa-exclamation-triangle"></i> Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('<i class="fas fa-exclamation-triangle"></i> Network error when deleting container');
    });
}

function renewContainer() {
    // Disable the button and show loading spinner
    const renewBtn = document.querySelector('button.btn-info');
    renewBtn.disabled = true;
    renewBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Renewing...';

    fetch('/api/v1/plugins/ctfd-whale/container', {
        method: 'PATCH',
        credentials: 'same-origin',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('<i class="fas fa-check-circle"></i> Desktop session renewed successfully', 'success');
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showAlert('<i class="fas fa-exclamation-triangle"></i> Error: ' + data.message);
            // Re-enable button
            renewBtn.disabled = false;
            renewBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Renew Session';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('<i class="fas fa-exclamation-triangle"></i> Network error when renewing container');
        // Re-enable button
        renewBtn.disabled = false;
        renewBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Renew Session';
    });
}

document.addEventListener('DOMContentLoaded', function() {
    // Add click handlers to all launch buttons
    document.querySelectorAll('.launch-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const templateId = this.getAttribute('data-template-id');
            launchDesktop(templateId);
        });
    });
});

function launchDesktop(templateId) {
    // Disable all launch buttons
    document.querySelectorAll('.launch-btn').forEach(btn => {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Starting...';
    });

    // Create loading overlay
    const loadingOverlay = document.createElement('div');
    loadingOverlay.id = 'loading-overlay';
    loadingOverlay.style = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:9999; display:flex; justify-content:center; align-items:center;';

    // Create loading content
    const loadingContent = document.createElement('div');
    loadingContent.style = 'background:white; padding:30px; border-radius:10px; text-align:center; max-width:500px;';
    loadingContent.innerHTML = `
        <h4><i class="fas fa-server"></i> Launching Desktop Environment</h4>
        <div class="progress mt-3 mb-3">
            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
                 style="width: 100%"></div>
        </div>
        <p id="launch-status">Initializing container...</p>
        <small class="text-muted">This may take a moment. Please don't refresh the page.</small>
    `;

    loadingOverlay.appendChild(loadingContent);
    document.body.appendChild(loadingOverlay);

    // Update status function
    const updateStatus = (message) => {
        document.getElementById('launch-status').innerText = message;
    };

    // Animation sequence
    setTimeout(() => updateStatus('Creating container...'), 1000);
    setTimeout(() => updateStatus('Configuring network...'), 3000);
    setTimeout(() => updateStatus('Starting desktop services...'), 5000);

    // Call the API to launch a desktop
    fetch(`/api/v1/plugins/webdesktop/launch/${templateId}`, {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateStatus('Desktop is ready! Redirecting...');

            // Show success animation
            loadingContent.innerHTML = `
                <div class="text-center">
                    <div class="circle-loader">
                        <div class="checkmark draw"></div>
                    </div>
                    <h4 class="mt-3">Desktop Ready!</h4>
                    <p>Redirecting to your desktop environment...</p>
                </div>
            `;

            // Add the success animation class
            setTimeout(() => {
                document.querySelector('.circle-loader').classList.add('load-complete');
                document.querySelector('.checkmark').style.display = 'block';
            }, 500);

            setTimeout(() => {
                window.location.reload();
            }, 2500);
        } else {
            // Remove loading overlay
            document.body.removeChild(loadingOverlay);

            showAlert(`<i class="fas fa-exclamation-triangle"></i> ${data.message}`);
            // Re-enable buttons
            document.querySelectorAll('.launch-btn').forEach(btn => {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-rocket"></i> Launch Desktop';
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);

        // Remove loading overlay
        document.body.removeChild(loadingOverlay);

        showAlert('<i class="fas fa-exclamation-triangle"></i> An unexpected error occurred');
        // Re-enable buttons
        document.querySelectorAll('.launch-btn').forEach(btn => {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-rocket"></i> Launch Desktop';
        });
    });
}

{% if container %}
// Add timer functionality for active container
const timeout = {{ get_config("whale:docker_timeout", 3600) }};
const startTime = new Date("{{ container.start_time.isoformat() }}");
const currentTime = new Date();
const elapsedSeconds = Math.floor((currentTime - startTime) / 1000);
let remainingSeconds = Math.max(0, timeout - elapsedSeconds);

// Add timer display to the session info card
const sessionCard = document.querySelector('.card-header.bg-primary').parentNode.querySelector('.card-body');
const timerElement = document.createElement('div');
timerElement.innerHTML = `
    <p><strong>Remaining Time:</strong> <span id="timer">Calculating...</span></p>
    <div class="progress">
        <div id="timer-progress" class="progress-bar" role="progressbar" style="width: 100%"
             aria-valuenow="100" aria-valuemin="0" aria-valuemax="100">100%</div>
    </div>
`;
sessionCard.insertBefore(timerElement, document.getElementById('action-buttons'));

function formatTime(seconds) {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;

    if (hours > 0) {
        return `${hours}h ${minutes}m ${secs}s`;
    } else {
        return `${minutes}m ${secs}s`;
    }
}

function updateTimer() {
    const timerElement = document.getElementById('timer');
    const progressBar = document.getElementById('timer-progress');

    if (!timerElement || !progressBar) return;

    // Update timer text
    timerElement.textContent = formatTime(remainingSeconds);

    // Update progress bar
    const percentage = Math.max(0, Math.floor((remainingSeconds / timeout) * 100));
    progressBar.style.width = `${percentage}%`;
    progressBar.setAttribute('aria-valuenow', percentage);
    progressBar.textContent = `${percentage}%`;

    // Update color based on time remaining
    if (percentage < 20) {
        progressBar.className = 'progress-bar bg-danger';
        timerElement.style.color = '#dc3545';
        timerElement.style.fontWeight = 'bold';
    } else if (percentage < 50) {
        progressBar.className = 'progress-bar bg-warning';
    } else {
        progressBar.className = 'progress-bar bg-success';
    }

    // Decrement timer
    remainingSeconds--;

    // Check if expired
    if (remainingSeconds <= 0) {
        clearInterval(timerInterval);
        timerElement.textContent = 'EXPIRED';
        progressBar.style.width = '0%';
        showAlert('<i class="fas fa-exclamation-triangle"></i> Your desktop session has expired', 'warning');
        setTimeout(() => window.location.reload(), 3000);
    }
}

// Start timer
const timerInterval = setInterval(updateTimer, 1000);
updateTimer(); // Initial update
{% endif %}
</script>
{% endblock %}